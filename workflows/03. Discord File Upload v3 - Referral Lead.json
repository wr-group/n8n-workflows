{
  "updatedAt": "2026-01-04T14:14:44.633Z",
  "createdAt": "2026-01-01T07:44:39.231Z",
  "id": "RBKVsJedeWvoIpth",
  "name": "03. Discord File Upload v3 - Referral Lead",
  "description": null,
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "13lFnQiBUmo1W0oQoTNlcn94ouflhuRWlMYu9NQV7taQ",
          "mode": "list",
          "cachedResultName": "Leads Logs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13lFnQiBUmo1W0oQoTNlcn94ouflhuRWlMYu9NQV7taQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "raw",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/13lFnQiBUmo1W0oQoTNlcn94ouflhuRWlMYu9NQV7taQ/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $now.setZone('Australia/Brisbane').toFormat('LL/dd/yyyy, HH:mm:ss') }}\n",
            "Id": "={{ $json.id }}",
            "Lead Type": "={{ $json.leadType }}",
            "First Name": "={{ $json.firstName }}",
            "Last Name": "={{ $json.lastName }}",
            "Mobile Number": "={{ $json.mobileNumber }}",
            "Email Address": "={{ $json.emailAddress }}",
            "Phone Number": "={{ $json.phoneNumber }}",
            "Address": "={{ $json.address }}",
            "State": "={{ $json.state }}",
            "Postal Code": "={{ $json.postalCode }}",
            "Suburb": "={{ $json.suburb }}",
            "Enquiry": "={{ $json.enquiry }}",
            "Quantity": "={{ $json.quantity }}",
            "Iâ€™d Like To Get My Project Underway": "={{ $json.IdLikeToGetMyProjectUnderway }}",
            "How they heard about us": "={{ $json.howTheyHeardAboutUs }}",
            "Lead Qualifier": "=Good",
            "Referred By": "={{ $json.referredBy }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Id",
              "displayName": "Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Lead Type",
              "displayName": "Lead Type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "First Name",
              "displayName": "First Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Last Name",
              "displayName": "Last Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Mobile Number",
              "displayName": "Mobile Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone Number",
              "displayName": "Phone Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Email Address",
              "displayName": "Email Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "State",
              "displayName": "State",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Suburb",
              "displayName": "Suburb",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Postal Code",
              "displayName": "Postal Code",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Enquiry",
              "displayName": "Enquiry",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Iâ€™d Like To Get My Project Underway",
              "displayName": "Iâ€™d Like To Get My Project Underway",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "How they heard about us",
              "displayName": "How they heard about us",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Lead Qualifier",
              "displayName": "Lead Qualifier",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Referred By",
              "displayName": "Referred By",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1984,
        -208
      ],
      "id": "a1a4e2aa-c23b-4615-bc74-0725b0395ec4",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "S4FmXrss6MgN5rzt",
          "name": "WR: Google Sheets Account"
        }
      }
    },
    {
      "parameters": {
        "name": "={{\n  [\n    $now.setZone('Australia/Brisbane').toFormat('dd-MM-yy') || '',\n    $json.leadType || '',\n    $json.firstName || '',\n    $json.lastName || '',\n    $json.attachmentName || '',\n    \n  ]\n    .filter(p => p && p !== '')\n    .join('_')\n}}\n",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1nfOvAb06F8r_K8K_kHUPquGbtS3bEqNO",
          "mode": "list",
          "cachedResultName": "Referrals Lead",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1nfOvAb06F8r_K8K_kHUPquGbtS3bEqNO"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        512,
        -88
      ],
      "id": "55610585-af3f-4206-b81b-97502f930043",
      "name": "Upload file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "cO0NLqiTRlyGeXAH",
          "name": "WR: Google Drive Account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "=Extract ALL readable text from this image exactly as written.\nDo NOT summarize.\nDo NOT interpret.\nDo NOT guess.\nPreserve line breaks where possible.\nReturn plain text only.\n",
        "inputType": "=data",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        512,
        -280
      ],
      "id": "1cbf1c09-7e06-4075-b559-f01c5d3df6a2",
      "name": "convert images to text",
      "credentials": {
        "openAiApi": {
          "id": "oQQrCQWqdo1CuRzx",
          "name": "WRai: OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "guildIds": [
          "753455160209965106"
        ],
        "channelIds": [
          "1456267299857109143"
        ],
        "roleIds": [
          "901010019900882994",
          "901010696152698890"
        ],
        "pattern": "every",
        "additionalFields": {
          "attachmentsRequired": true
        }
      },
      "type": "n8n-nodes-discord-trigger-new.discordTrigger",
      "typeVersion": 1,
      "position": [
        -160,
        -112
      ],
      "id": "d00adc68-6d18-4165-b28b-d96d185875a4",
      "name": "Listen to Discord messages",
      "credentials": {
        "discordBotTriggerApi": {
          "id": "bWnCMGqUZEPKKfgs",
          "name": "WR: Discord Bot Trigger Account"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "react",
        "guildId": {
          "__rl": true,
          "value": "753455160209965106",
          "mode": "list",
          "cachedResultName": "Window Revival",
          "cachedResultUrl": "https://discord.com/channels/753455160209965106"
        },
        "channelId": {
          "__rl": true,
          "value": "={{ $json.channelId }}",
          "mode": "id"
        },
        "messageId": "={{ $json.id }}",
        "emoji": "ðŸ‘"
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        1984,
        -16
      ],
      "id": "febf8476-8149-45fa-9b2a-e63a791f8998",
      "name": "React with an emoji to a message",
      "webhookId": "18a1ca72-b786-42c3-9512-3f924d16c8b9",
      "credentials": {
        "discordBotApi": {
          "id": "a0FDlWFh8PBA5Add",
          "name": "WR: Discord Bot Account"
        }
      }
    },
    {
      "parameters": {
        "resource": "message",
        "guildId": {
          "__rl": true,
          "value": "753455160209965106",
          "mode": "list",
          "cachedResultName": "Window Revival",
          "cachedResultUrl": "https://discord.com/channels/753455160209965106"
        },
        "channelId": {
          "__rl": true,
          "value": "912496260823519232",
          "mode": "list",
          "cachedResultName": "leadsãƒ»new",
          "cachedResultUrl": "https://discord.com/channels/753455160209965106/912496260823519232"
        },
        "content": "===========\nLead Type: {{ $json.leadType }}\nTimestamp: {{ $now.setZone('Australia/Brisbane').toFormat('LL/dd/yyyy, HH:mm:ss') }}\nId: {{ $json.id }}\nFirst Name: {{ $json.firstName }}\nLast Name: {{ $json.lastName }}\nMobile Number: {{ $json.mobileNumber }}\nPhone Number: {{ $json.phoneNumber }}\nEmail Address: {{ $json.emailAddress }}\nAddress: {{ $json.address }}\nState: {{ $json.state }}\nSuburb: {{ $json.suburb }}\nEnquiry: {{ $json.enquiry }}\nQuantity: {{ $json.quantity }}\nI'd Like to Get My Project Underway: {{ $json.IdLikeToGetMyProjectUnderway }}\nHow they heard about us?: {{ $json.howTheyHeardAboutUs }}\nLead Qualifier: \"Good\"\nReferred by: {{ $json.referredBy }}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.discord",
      "typeVersion": 2,
      "position": [
        1984,
        -400
      ],
      "id": "675675ea-aeba-463a-a556-320af7403f46",
      "name": "Send a message",
      "webhookId": "809bfe58-a56a-4911-8d09-becf03e700da",
      "credentials": {
        "discordBotApi": {
          "id": "a0FDlWFh8PBA5Add",
          "name": "WR: Discord Bot Account"
        }
      }
    },
    {
      "parameters": {
        "url": "https://wrapp2-testing.windowrevival.com.au/api/search?q=86921&type=contact",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.candidates.q }}"
            },
            {
              "name": "type",
              "value": "contact"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2432,
        248
      ],
      "id": "b810a361-69ea-4d6f-a499-a0a6af6dfe95",
      "name": "Search Contact",
      "credentials": {
        "httpHeaderAuth": {
          "id": "UTs7Hb7x8Xe72hTe",
          "name": "WR: Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// n8n Function node\n\nconst candidates = [];\n\nconst clean = (v) => String(v ?? \"\").trim();\n\nconst normalizeAuNumber9 = (v) => {\n  let digits = clean(v).replace(/\\D/g, \"\"); // keep digits only\n  if (!digits) return \"\";\n\n  // Remove common AU prefixes\n  if (digits.startsWith(\"61\")) digits = digits.slice(2); // +61 / 61\n  if (digits.startsWith(\"0\")) digits = digits.slice(1);  // 04.. or 02.. etc\n\n  // Force to last 9 digits (mobile/landline after removing 0 is typically 9 digits)\n  if (digits.length > 9) digits = digits.slice(-9);\n\n  return digits;\n};\n\n// Email candidate (as-is)\nif (clean($json.email)) {\n  candidates.push({ q: clean($json.email), by: \"email\" });\n}\n\n// Mobile candidate (normalized to 9 digits)\nconst mobile9 = normalizeAuNumber9($json.mobileNumber);\nif (mobile9) {\n  candidates.push({ q: mobile9, by: \"mobile\" });\n}\n\n// Phone candidate (normalized to 9 digits)\nconst phone9 = normalizeAuNumber9($json.phoneNumber);\nif (phone9) {\n  candidates.push({ q: phone9, by: \"phone\" });\n}\n\nreturn [{ ...$json, candidates, found: false }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1984,
        176
      ],
      "id": "7e2cf613-e00f-41ea-a50f-7d689d4fe775",
      "name": "Search by Email, Mobile, Phone"
    },
    {
      "parameters": {
        "fieldToSplitOut": "candidates",
        "include": "selectedOtherFields",
        "fieldsToInclude": "googlesheet_id",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        2208,
        248
      ],
      "id": "5f64d1dc-8cf1-45fd-a553-fa7ea9dce165",
      "name": "Split Out"
    },
    {
      "parameters": {
        "jsCode": "// n8n Function node (place AFTER HTTP Request)\n//\n// Output only:\n// - id          (from Split Out -> googlesheet_id)\n// - status\n// - found\n// - contact_id  (from API contact[0].id when found)\n// - message     (2 lines when found)\n//\n// Removes original `data` and does not include `parsed`.\n\nlet parsed;\ntry {\n  parsed = typeof $json.data === \"string\" ? JSON.parse($json.data) : ($json.data ?? {});\n} catch (e) {\n  parsed = {};\n}\n\nconst status = parsed?.status ?? null;\n\nconst apiMessage = parsed?.data?.message ?? null;     // e.g. \"Data not found\"\nconst apiContactRaw = parsed?.data?.contact ?? null;  // e.g. \"[{ \\\"id\\\": 86940, ...}]\"\n\n// Parse contact array if present (it is a JSON string in your payload)\nlet contactArr = [];\nif (typeof apiContactRaw === \"string\" && apiContactRaw.trim() !== \"\") {\n  try {\n    contactArr = JSON.parse(apiContactRaw);\n  } catch (e) {\n    contactArr = [];\n  }\n}\n\n// Determine found:\n// Prefer actual contact data; fallback to message check\nconst found = (Array.isArray(contactArr) && contactArr.length > 0)\n  ? true\n  : !(typeof apiMessage === \"string\" && apiMessage.toLowerCase().includes(\"data not found\"));\n\n// Extract contact_id if found\nconst contact_id = (found && Array.isArray(contactArr) && contactArr[0]?.id != null)\n  ? contactArr[0].id\n  : null;\n\n// 2-line message when found\nconst message = found\n  ? `Contact found\\ncontact_id: ${contact_id}`\n  : \"No contact found (checked email, mobile, and phone).\";\n\n// Pull id from the \"Split Out\" node\nconst id = $('Split Out').first().json.googlesheet_id ?? null;\n\nreturn [{\n  id,\n  status,\n  found,\n  contact_id,\n  message,\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2656,
        248
      ],
      "id": "a1bac795-16bc-4aaf-a488-c644c1844203",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "1ab2a24b-d655-40c5-88c3-1e79d143c2bf",
              "leftValue": "={{ $json.found }}",
              "rightValue": "success",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2880,
        248
      ],
      "id": "c32d3e8d-4850-49cd-a1a3-a99f3761662d",
      "name": "If Search is True the send response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wrapp2-testing.windowrevival.com.au/api/opportunities/create",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"contact_id\" : \"{{ $json.contact_id }}\",\n    \"lead_source\" : 9,\n    \"pipeline\" : 53,\n    \"product_interest\" : \"\",\n    \"description\" : \"{{ $json.enquiry }}\",\n    \"next_action\" : \"\",\n    \"action_date\" : \"\",\n    \"owner_id\" : 25,\n    \"status\" : 1,\n    \"home_phone\" : \"\",\n    \"work_phone\" : \"{{ $json.phoneNumber }}\",\n    \"mobile\" : \"{{ $json.mobileNumber }}\",\n    \"street\" : \"{{ $json.address }}\",\n    \"suburb\" : 2,\n    \"state\" : 1,\n    \"postal\" : \"{{ $json.postalCode }}\",\n    \"longitude\" : 0,\n    \"latitude\" : 0,\n    \"revenue\" : 0,\n    \"chance\" : 50,\n    \"call_result\" : 2,\n    \"contact_name\" : \"{{ $json.firstName }} {{ $json.lastName }}\",\n    \"email\" : \"{{ $json.emailAddress }}\"\n} ",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3552,
        176
      ],
      "id": "971b6dd9-2bfd-425a-9328-a9bacf2e5e3b",
      "name": "Create Opportunity",
      "credentials": {
        "httpHeaderAuth": {
          "id": "UTs7Hb7x8Xe72hTe",
          "name": "WR: Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        3104,
        176
      ],
      "id": "3755c4af-8341-4e57-9ba5-53cd9a3a0d87",
      "name": "Search Item"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7c753874-2708-4658-9211-ab1a07be7f81",
              "name": "id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "7fd6c372-a574-46eb-b8a8-4ca5514c2bb4",
              "name": "leadType",
              "value": "={{ $json.leadType }}",
              "type": "string"
            },
            {
              "id": "319cbc2f-686c-4690-b0da-99edb563a4d9",
              "name": "firstName",
              "value": "={{ $json.firstName }}",
              "type": "string"
            },
            {
              "id": "e318f933-3a86-4e92-8d45-fdd5c9d6db45",
              "name": "lastName",
              "value": "={{ $json.lastName }}",
              "type": "string"
            },
            {
              "id": "1033f6f6-ff3d-462c-a819-0253ba1097a9",
              "name": "mobileNumber",
              "value": "={{ $json.mobileNumber }}",
              "type": "string"
            },
            {
              "id": "42c58a65-dab0-4938-a047-f6beba67e9d3",
              "name": "phoneNumber",
              "value": "={{ $json.phoneNumber }}",
              "type": "string"
            },
            {
              "id": "75060d69-eaa3-4924-b9f6-b7cf159502d4",
              "name": "emailAddress",
              "value": "={{ $json.emailAddress }}",
              "type": "string"
            },
            {
              "id": "2420ae52-e6a5-4d5e-889a-014ad00b28b2",
              "name": "address",
              "value": "={{ $json.address }}",
              "type": "string"
            },
            {
              "id": "421623c8-2db6-4b40-a102-f6dc36ff61ed",
              "name": "state",
              "value": "={{ $json.state }}",
              "type": "string"
            },
            {
              "id": "7cc111a4-9134-4fe3-97eb-75b5e81c8d31",
              "name": "suburb",
              "value": "={{ $json.suburb }}",
              "type": "string"
            },
            {
              "id": "518ce6f1-f3a0-4e61-b483-c85feb63ae15",
              "name": "postalCode",
              "value": "={{ $json.postalCode }}",
              "type": "string"
            },
            {
              "id": "fb3af799-02a3-4669-97b7-5616f9bc8d93",
              "name": "enquiry",
              "value": "={{ $json.enquiry }}",
              "type": "string"
            },
            {
              "id": "e76aa2b3-3c3f-43d7-b9e2-8dfe2c4ecad3",
              "name": "quantity",
              "value": "={{ $json.quantity }}",
              "type": "string"
            },
            {
              "id": "193cbe77-7015-40c3-95b1-eba1fd89481c",
              "name": "leadQualifier",
              "value": "=Good",
              "type": "string"
            },
            {
              "id": "6c8b740a-0f64-4828-bc0a-f71e2bf6621b",
              "name": "referredBy",
              "value": "={{ $json.referredBy }}",
              "type": "string"
            },
            {
              "id": "265db7eb-7687-476b-96f5-11d030f8251a",
              "name": "channelId",
              "value": "={{ $json.channelId }}",
              "type": "string"
            },
            {
              "id": "59c5c353-8830-4285-9b9d-f3b53888cb50",
              "name": "authorId",
              "value": "={{ $json.authorId }}",
              "type": "string"
            },
            {
              "id": "33a52d4e-10f1-4357-90d4-de70e6873925",
              "name": "IdLikeToGetMyProjectUnderway",
              "value": "={{ $json.IdLikeToGetMyProjectUnderway }}",
              "type": "string"
            },
            {
              "id": "9c3726e2-0e35-4a55-8fb3-2cfc97653e48",
              "name": "howTheyHeardAboutUs",
              "value": "={{ $json.howTheyHeardAboutUs }}",
              "type": "string"
            },
            {
              "id": "4814f4f1-cea7-4c83-94c9-691ed2a48b65",
              "name": "messageId",
              "value": "={{ $json.messageId }}",
              "type": "string"
            },
            {
              "id": "d4db8a92-8dcb-451e-9f69-12399264c8e1",
              "name": "contact_id",
              "value": "={{ $json.contact_id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3328,
        176
      ],
      "id": "3766c103-c9bc-4b24-9102-e9126cd103a8",
      "name": "Search and Create Contact"
    },
    {
      "parameters": {
        "url": "={{ $json.imageAttachment.url }}\n\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0"
            },
            {
              "name": "Accept",
              "value": "image/*"
            },
            {
              "name": "Referer",
              "value": "https://discord.com/"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        288,
        -184
      ],
      "id": "c4b09967-033f-4535-8ffc-a473cefe3f6e",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// Node 2: Sanitize + Split Discord attachments into 1 item per image\n\nfunction cleanUrl(u) {\n  if (!u) return null;\n  let s = String(u).trim();\n  s = s.replace(/\\s+$/g, \"\");\n  s = s.replace(/[.]+$/g, \"\");\n  s = s.replace(/&+\\.*$/g, \"\"); // remove trailing & or &.\n  s = s.replace(/[.]+$/g, \"\");\n  return s;\n}\n\nfunction isImage(att) {\n  const ct = (att.contentType || \"\").toLowerCase();\n  const name = (att.name || \"\").toLowerCase();\n  if (ct.startsWith(\"image/\")) return true;\n  return /\\.(png|jpe?g|gif|webp|bmp|tiff?)$/i.test(name);\n}\n\nfunction pickBestUrl(att) {\n  const url = cleanUrl(att.url || att.attachment);\n  const proxy = cleanUrl(att.proxyURL);\n\n  // Prefer cdn.discordapp.com\n  if (url && url.includes(\"cdn.discordapp.com\")) return url;\n  if (proxy && proxy.includes(\"cdn.discordapp.com\")) return proxy;\n\n  return url || proxy || null;\n}\n\nconst msg = $input.first().json;\n\nconst attachments = Array.isArray(msg.attachments) ? msg.attachments : [];\nconst images = attachments\n  .filter(isImage)\n  .map(a => ({\n    id: a.id ?? null,\n    name: a.name ?? null,\n    url: pickBestUrl(a),\n    contentType: a.contentType ?? null,\n    size: a.size ?? null,\n    width: a.width ?? null,\n    height: a.height ?? null,\n    title: a.title ?? null,\n  }))\n  .filter(a => a.url)\n  .filter((a, idx, arr) => idx === arr.findIndex(x => (x.id || \"\") === (a.id || \"\")));\n\nconst base = {\n  messageId: msg.id ?? null,\n  guildId: msg.guildId ?? null,\n  channelId: msg.channelId ?? null,\n  authorId: msg.authorId ?? null,\n  authorName: msg.authorName ?? null,\n  leadType: \"Referral Lead\",\n  referredBy: (msg.content || \"\").trim(), // <- \"Paul Darby\"\n};\n\n// If no images, stop the workflow here\nif (!images.length) return [];\n\nreturn images.map(img => ({\n  json: {\n    ...base,\n    imageAttachment: img,\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -112
      ],
      "id": "e8ccc998-0f53-4abf-aa3a-56929486f751",
      "name": " Sanitize + Split Discord attachments into 1 item per image"
    },
    {
      "parameters": {
        "jsCode": "// Node 5: Merge OCR text from all images into ONE item\n\nconst items = $input.all();\n\n// Keep context fields (these should still be present from previous nodes)\nconst base = {\n  messageId: items[0]?.json?.messageId ?? null,\n  leadType: items[0]?.json?.leadType ?? \"Referral Lead\",\n  referredBy: items[0]?.json?.referredBy ?? \"\",\n};\n\n// Your OpenAI node output is nested like: [[{...}], [{...}], [{...}]]\n// This function extracts text safely from common shapes.\nfunction extractText(json) {\n  if (!json) return \"\";\n\n  // Case A: json is an array (like your [[{...}]])\n  if (Array.isArray(json)) {\n    return json\n      .map(extractText)\n      .filter(Boolean)\n      .join(\"\\n\\n---\\n\\n\");\n  }\n\n  // Case B: direct OpenAI shape: { content: [ { text: \"...\" } ] }\n  const t1 = json?.content?.[0]?.text;\n  if (typeof t1 === \"string\" && t1.trim()) return t1.trim();\n\n  // Case C: sometimes simplified\n  const t2 = json?.text || json?.output_text;\n  if (typeof t2 === \"string\" && t2.trim()) return t2.trim();\n\n  return \"\";\n}\n\n// Merge OCR texts in order\nconst ocrTexts = items\n  .map(i => extractText(i.json))\n  .map(t => (typeof t === \"string\" ? t.trim() : \"\"))\n  .filter(Boolean);\n\n// Final combined text (include referredBy first so itâ€™s available in parse)\nconst mergedText = [base.referredBy, ...ocrTexts].filter(Boolean).join(\"\\n\\n---\\n\\n\");\n\nreturn [{\n  json: {\n    ...base,\n    mergedText,\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        736,
        -280
      ],
      "id": "e61e8c33-89c8-4f9c-9b45-906a998807db",
      "name": "Merge all OCR text into ONE item"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "responses": {
          "values": [
            {
              "role": "system",
              "content": "=Referral Lead parsing rules (IMPORTANT):\n\nYou are a data extraction and normalization engine.\nOutput MUST be ONLY the completed JSON object shown at the bottom.\nDo NOT output emails, explanations, markdown, code fences, or any extra text.\nDo NOT add new keys. Use ONLY the keys in the JSON template.\n\nUse ALL provided text below. The referral lead details may be spread across multiple images/pages.\nThe text may contain one referral lead or multiple referral leads (up to 3).\nIf multiple referral leads are present, extract each one separately first, then merge them into ONE final referral lead.\nWhen merging, prefer the most complete, clearest, and most consistent information.\nExtract any clearly readable text that helps fill the fields (name, contact details, address, referral/job details).\n\nField mapping (IMPORTANT):\n- Put the customerâ€™s job request into \"enquiry\".\n- The \"enquiry\" MUST be a single clear, expanded description compiled from ALL relevant details found in the text.\n- Do NOT write an email or quote format.\n- Put phone numbers into \"mobileNumber\" when they look like an Australian mobile (start with 04).\n- Put any visible email into \"emailAddress\".\n\nName (IMPORTANT):\nAlways try to extract the referred customerâ€™s name from the text.\nIf the full name is shown, put the first word in \"firstName\" and the last word in \"lastName\".\nIf only one name is shown, put it in \"firstName\" and leave \"lastName\" empty.\n\nAddress rules:\n- If a full street address is visible, set \"address\" to the full street address.\n- If only a suburb/locality is visible, set \"address\" to the suburb/locality name.\n\nSuburb:\n- Always fill \"suburb\" when a suburb/locality is visible.\n- If \"address\" contains only a suburb/locality, copy it into \"suburb\".\n\nState (REQUIRED):\nClassify \"state\" using ONLY:\n\"NSW\"\n\"Brisbane\"\n\"Gold Coast\"\n\nPostcode (REQUIRED â€“ DERIVED):\n- If a postcode is visible in the text, use it.\n- If a postcode is NOT visible but a suburb/locality is present, you MUST derive the correct Australian postcode based on your geographic knowledge.\n- Always populate \"postalCode\" when the suburb is known.\n- Do NOT leave \"postalCode\" empty when suburb is identified.\n- Use the most commonly accepted postcode for that suburb.\n\nTEXT TO PARSE:\n{{ $json.mergedText }}\n\n{\n\"id\": \"{{ $json.messageId }}\",\n\"leadType\": \"{{ $json.leadType }}\",\n\"firstName\": \"\",\n\"lastName\": \"\",\n\"mobileNumber\": \"\",\n\"phoneNumber\": \"\",\n\"emailAddress\": \"\",\n\"address\": \"\",\n\"state\": \"\",\n\"suburb\": \"\",\n\"postalCode\": \"\",\n\"enquiry\": \"\",\n\"quantity\": \"\",\n\"IdLikeToGetMyProjectUnderway\": \"\",\n\"howTheyHeardAboutUs\": \"\",\n\"leadQualifier\": \"Good\",\n\"referredBy\": \"{{ $json.referredBy }}\"\n}\n"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        960,
        -280
      ],
      "id": "7d0c521b-dc6b-4502-b0b6-981e63624b48",
      "name": "Parse merged OCR text into final JSON",
      "credentials": {
        "openAiApi": {
          "id": "oQQrCQWqdo1CuRzx",
          "name": "WRai: OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Node 7: Merge parsed JSON results (from multiple images) into ONE final lead\n\nconst items = $input.all().map(i => {\n  // Your OpenAI output JSON is inside a string at:\n  // item.json.output[0].content[0].text\n  const raw = i.json?.output?.[0]?.content?.[0]?.text || \"\";\n  try {\n    return JSON.parse(raw);\n  } catch (e) {\n    return null;\n  }\n}).filter(Boolean);\n\nconst prefer = (a, b) => (b && String(b).trim() ? b : a);\n\n// Merge enquiry as unique lines joined by \" | \"\nfunction mergeEnquiry(a, b) {\n  const A = (a || \"\").trim();\n  const B = (b || \"\").trim();\n  if (!A) return B;\n  if (!B) return A;\n\n  const parts = A.split(\"|\").map(s => s.trim()).filter(Boolean);\n  if (!parts.includes(B)) parts.push(B);\n  return parts.join(\" | \");\n}\n\nconst merged = items.reduce((acc, cur) => {\n  acc.id = prefer(acc.id, cur.id);\n  acc.leadType = prefer(acc.leadType, cur.leadType);\n\n  acc.firstName = prefer(acc.firstName, cur.firstName);\n  acc.lastName = prefer(acc.lastName, cur.lastName);\n\n  acc.mobileNumber = prefer(acc.mobileNumber, cur.mobileNumber);\n  acc.phoneNumber = prefer(acc.phoneNumber, cur.phoneNumber);\n  acc.emailAddress = prefer(acc.emailAddress, cur.emailAddress);\n\n  acc.address = prefer(acc.address, cur.address);\n  acc.state = prefer(acc.state, cur.state);\n  acc.suburb = prefer(acc.suburb, cur.suburb);\n  acc.postalCode = prefer(acc.postalCode, cur.postalCode);\n\n  acc.enquiry = mergeEnquiry(acc.enquiry, cur.enquiry);\n\n  acc.quantity = prefer(acc.quantity, cur.quantity);\n  acc.IdLikeToGetMyProjectUnderway = prefer(acc.IdLikeToGetMyProjectUnderway, cur.IdLikeToGetMyProjectUnderway);\n  acc.howTheyHeardAboutUs = prefer(acc.howTheyHeardAboutUs, cur.howTheyHeardAboutUs);\n  acc.leadQualifier = prefer(acc.leadQualifier, cur.leadQualifier);\n\n  acc.referredBy = prefer(acc.referredBy, cur.referredBy);\n\n  return acc;\n}, {\n  id: \"\",\n  leadType: \"Referral Lead\",\n  firstName: \"\",\n  lastName: \"\",\n  mobileNumber: \"\",\n  phoneNumber: \"\",\n  emailAddress: \"\",\n  address: \"\",\n  state: \"\",\n  suburb: \"\",\n  postalCode: \"\",\n  enquiry: \"\",\n  quantity: \"\",\n  IdLikeToGetMyProjectUnderway: \"\",\n  howTheyHeardAboutUs: \"\",\n  leadQualifier: \"Good\",\n  referredBy: \"\",\n});\n\nreturn [{ json: merged }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        -280
      ],
      "id": "3669fe59-53c9-4d1d-89d6-b35247030498",
      "name": "Parsing text"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1536,
        -112
      ],
      "id": "da7094d3-812d-47e2-9fcf-9e7938a95e99",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1fd1615f-a49b-4918-ba76-ce5e1bf41bc5",
              "name": "id",
              "value": "={{ $json.messageId }}",
              "type": "string"
            },
            {
              "id": "116a94cb-3d2d-49b4-a14e-01b7a614ea78",
              "name": "leadType",
              "value": "={{ $json.leadType }}",
              "type": "string"
            },
            {
              "id": "9b063ab7-9929-4194-a4ae-f1904fe80801",
              "name": "firstName",
              "value": "={{ $json.firstName }}",
              "type": "string"
            },
            {
              "id": "22b31d19-3023-4b69-8351-1ea56fd7d0a9",
              "name": "lastName",
              "value": "={{ $json.lastName }}",
              "type": "string"
            },
            {
              "id": "53a62834-84cf-42ab-8fe1-18e1b14960c6",
              "name": "mobileNumber",
              "value": "={{ $json.mobileNumber }}",
              "type": "string"
            },
            {
              "id": "a79aba94-7683-4fde-9531-a8188c1e94cf",
              "name": "phoneNumber",
              "value": "={{ $json.phoneNumber }}",
              "type": "string"
            },
            {
              "id": "6c7a3d31-a80c-4143-a7a7-5a5f0f870eb8",
              "name": "emailAddress",
              "value": "={{ $json.emailAddress }}",
              "type": "string"
            },
            {
              "id": "7afc5002-43d2-4c58-9cb2-15547a5d0e3b",
              "name": "address",
              "value": "={{ $json.address }}",
              "type": "string"
            },
            {
              "id": "17f0f172-ab52-48b5-8945-4019fcd05aa8",
              "name": "state",
              "value": "={{ $json.state }}",
              "type": "string"
            },
            {
              "id": "5657889c-28d4-4b08-bdab-40e6f0ff49a3",
              "name": "suburb",
              "value": "={{ $json.suburb }}",
              "type": "string"
            },
            {
              "id": "f03c28c8-29e8-4a00-914e-db48ccf2d5ae",
              "name": "postalCode",
              "value": "={{ $json.postalCode }}",
              "type": "string"
            },
            {
              "id": "2f2b69db-c9e7-42f8-a72f-50d5d3431c8b",
              "name": "enquiry",
              "value": "={{ $json.enquiry }}",
              "type": "string"
            },
            {
              "id": "103bfeba-973f-4bc0-b13b-bbd464151d07",
              "name": "quantity",
              "value": "={{ $json.quantity }}",
              "type": "string"
            },
            {
              "id": "f101e56d-e249-473b-b525-ebf78b0c2ab1",
              "name": "quantity",
              "value": "={{ $json.quantity }}",
              "type": "string"
            },
            {
              "id": "0a28d87c-65cc-4c70-b700-16b600cda5cd",
              "name": "IdLikeToGetMyProjectUnderway",
              "value": "={{ $json.IdLikeToGetMyProjectUnderway }}",
              "type": "string"
            },
            {
              "id": "b16a3c0a-5bed-4ecc-b426-1e9a81d62718",
              "name": "howTheyHeardAboutUs",
              "value": "={{ $json.howTheyHeardAboutUs }}",
              "type": "string"
            },
            {
              "id": "930f02bc-e607-49c2-a0da-e62223833c20",
              "name": "referredBy",
              "value": "={{ $json.referredBy }}",
              "type": "string"
            },
            {
              "id": "fe00f10b-ec70-407b-9696-22d7714d12c9",
              "name": "channelId",
              "value": "={{ $json.channelId }}",
              "type": "string"
            },
            {
              "id": "676119b1-0648-40c6-b4fd-06e8ce03b9c6",
              "name": "authorId",
              "value": "={{ $json.authorId }}",
              "type": "string"
            },
            {
              "id": "57d583cc-72b9-4a14-a46d-cf6cd98bf809",
              "name": "authorName",
              "value": "={{ $json.authorName }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1760,
        -112
      ],
      "id": "5b9e8bc1-b632-4c02-9e36-e8142653f1ec",
      "name": "Set Referral Leads"
    }
  ],
  "connections": {
    "Append row in sheet": {
      "main": [
        []
      ]
    },
    "Upload file": {
      "main": [
        []
      ]
    },
    "convert images to text": {
      "main": [
        [
          {
            "node": "Merge all OCR text into ONE item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listen to Discord messages": {
      "main": [
        [
          {
            "node": " Sanitize + Split Discord attachments into 1 item per image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Contact": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search by Email, Mobile, Phone": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search Item",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "Search Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "If Search is True the send response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Search is True the send response": {
      "main": [
        [
          {
            "node": "Search Item",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Search Item": {
      "main": [
        [
          {
            "node": "Search and Create Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search and Create Contact": {
      "main": [
        [
          {
            "node": "Create Opportunity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "convert images to text",
            "type": "main",
            "index": 0
          },
          {
            "node": "Upload file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    " Sanitize + Split Discord attachments into 1 item per image": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge all OCR text into ONE item": {
      "main": [
        [
          {
            "node": "Parse merged OCR text into final JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse merged OCR text into final JSON": {
      "main": [
        [
          {
            "node": "Parsing text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsing text": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Set Referral Leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Referral Leads": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          },
          {
            "node": "React with an emoji to a message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search by Email, Mobile, Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "225d7c52-f5c2-4463-b8d4-18e35cc7096a",
  "activeVersionId": null,
  "versionCounter": 121,
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-01-01T07:44:39.234Z",
      "createdAt": "2026-01-01T07:44:39.234Z",
      "role": "workflow:owner",
      "workflowId": "RBKVsJedeWvoIpth",
      "projectId": "6TsYTzg0HY92xH2K",
      "project": {
        "updatedAt": "2025-11-14T08:33:27.896Z",
        "createdAt": "2025-11-14T07:49:25.938Z",
        "id": "6TsYTzg0HY92xH2K",
        "name": "Christine Kam <windowrevival@gmail.com>",
        "type": "personal",
        "icon": null,
        "description": null,
        "creatorId": "bc31a112-3ed8-48ca-b94c-7225571c3d7b",
        "projectRelations": [
          {
            "updatedAt": "2025-11-14T07:49:25.938Z",
            "createdAt": "2025-11-14T07:49:25.938Z",
            "userId": "bc31a112-3ed8-48ca-b94c-7225571c3d7b",
            "projectId": "6TsYTzg0HY92xH2K",
            "user": {
              "updatedAt": "2026-02-10T14:01:06.000Z",
              "createdAt": "2025-11-14T07:49:14.641Z",
              "id": "bc31a112-3ed8-48ca-b94c-7225571c3d7b",
              "email": "windowrevival@gmail.com",
              "firstName": "Christine",
              "lastName": "Kam",
              "personalizationAnswers": {
                "version": "v4",
                "personalization_survey_submitted_at": "2025-11-14T08:34:38.735Z",
                "personalization_survey_n8n_version": "1.119.1",
                "automationGoalDevops": [
                  "reporting",
                  "other"
                ],
                "automationGoalDevopsOther": "Automate all apps",
                "companySize": "<20",
                "companyType": "systems-integrator",
                "role": "it",
                "reportedSource": "google"
              },
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "ZwjGOdSLvNlPoB1E",
                "userActivatedAt": 1763281773859,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1763554974919
                }
              },
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2026-02-11",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": [
    {
      "updatedAt": "2025-11-25T13:05:18.454Z",
      "createdAt": "2025-11-25T13:05:18.454Z",
      "id": "xn6seEX74pkTOLqC",
      "name": "@lead"
    }
  ],
  "activeVersion": null
}